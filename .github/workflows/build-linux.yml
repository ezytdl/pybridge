name: ezytdl/linux pybridge dist
run-name: ${{ github.actor }} - ${{ github.event_name }} - ${{ github.sha }}

on:
  workflow_call:
    inputs:
      release_id:
        description: 'Release ID'
        type: string
        required: true

jobs:
  linux-dist:
    runs-on: ubuntu-latest

    permissions: write-all

    steps:
        - name: Checkout repo
          uses: actions/checkout@v2
        
        - name: Install python
          uses: actions/setup-python@v4
          with:
            python-version: '3.11'
            cache: 'pip'
  
        - name: Install pybridge deps
          run: |
            pip install -r requirements.txt
  
        - name: Build app
          run: |
            python constants.py
            pyinstaller bridge.py --add-data "constants.json:." --workpath "dist/build" --specpath "dist/build" -y --name "bridge-linux" --clean --noconfirm --onefile
            pyinstaller bridge.py --add-data "constants.json:." --workpath "dist/build" --specpath "dist/build" -y --name "bridge-linux-zip" --clean --noconfirm
  
        - name: Bundle everything in the destination dist/build/bridge-linux folder into a ZIP with 7zip, and place that in dist/
          run: |
            7z a -r ./dist/bridge-linux.zip ./dist/build/bridge-linux-zip/*

        - name: Upload files to release_id
          uses: xresloader/upload-to-github-release@main
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            release_id: ${{ inputs.release_id }}
            file: ./dist/bridge-linux*
            overwrite: true
            verbose: true
            draft: true
  